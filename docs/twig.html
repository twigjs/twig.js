<!DOCTYPE html>  <html> <head>   <title>twig.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               twig.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <pre><code>Twig.js v0.3
Copyright (c) 2011 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Create and compile a twig.js template.</span>
<span class="cm"> *</span>
<span class="cm"> * @param {Object} param Paramteres for creating a Twig template.</span>
<span class="cm"> *</span>
<span class="cm"> * @return {Twig.Template} A Twig template ready for rendering.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">twig</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">twig</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">debug</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">debug</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">debug</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">data</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">Template</span><span class="p">({</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span>
            <span class="nx">id</span><span class="o">:</span>   <span class="nx">id</span>
        <span class="p">});</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">ref</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Both ref and id cannot be set on a twig.js template.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">ref</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">href</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span><span class="p">.</span><span class="nx">loadRemote</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span><span class="p">,</span>
            <span class="nx">precompiled</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">precompiled</span>

        <span class="p">},</span> <span class="nx">params</span><span class="p">.</span><span class="nx">async</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">load</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Extend Twig with a new filter.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">twig</span><span class="p">.</span><span class="nx">extendFilter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">,</span> <span class="nx">definition</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">extendFilter</span><span class="p">(</span><span class="nx">filter</span><span class="p">,</span> <span class="nx">definition</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Extend Twig with a new test.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">twig</span><span class="p">.</span><span class="nx">extendTest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span> <span class="nx">definition</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">extendFilter</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span> <span class="nx">definition</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Extend Twig with a new definition.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">twig</span><span class="p">.</span><span class="nx">extendTag</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">definition</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">definition</span><span class="p">);</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * Provide an extension for use with express.</span>
<span class="cm"> *</span>
<span class="cm"> * @param {string} markup The template markup.</span>
<span class="cm"> * @param {array} options The express options.</span>
<span class="cm"> *</span>
<span class="cm"> * @return {string} The rendered template.</span>
<span class="cm"> */</span>
<span class="nx">twig</span><span class="p">.</span><span class="nx">compile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">markup</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">filename</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Try to load the template from the cache</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">Template</span><span class="p">({</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">markup</span><span class="p">,</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span>
        <span class="p">});</span> <span class="c1">// Twig.Templates.load(id) ||</span>

    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">template</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>twig.core.js</h2>

<p>This file handles template level tokenizing, compiling and parsing.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Twig</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="nx">Twig</span><span class="p">.</span><span class="nx">trace</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">debug</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Exception thrown by twig.js.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
       <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;TwigException&quot;</span><span class="p">;</span>
       <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;TwigException&quot;</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Get the string representation of a Twig error.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Wrapper for logging to the console.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">trace</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">trace</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">)</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">));}},</span>
        <span class="nx">debug</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">debug</span> <span class="o">&amp;&amp;</span> <span class="nx">console</span><span class="p">)</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">));}}</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Container for methods related to handling high level template tokens</span>
<span class="cm">     *      (for example: {{ expression }}, {% logic %}, {# comment #}, raw data)</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="cm">/**</span>
<span class="cm">     * Token types.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">output</span><span class="o">:</span>  <span class="s1">&#39;output&#39;</span><span class="p">,</span>
        <span class="nx">logic</span><span class="o">:</span>   <span class="s1">&#39;logic&#39;</span><span class="p">,</span>
        <span class="nx">comment</span><span class="o">:</span> <span class="s1">&#39;comment&#39;</span><span class="p">,</span>
        <span class="nx">raw</span><span class="o">:</span>     <span class="s1">&#39;raw&#39;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Token syntax definitions.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">definitions</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><em>Output type tokens</em></p>

<p>These typically take the form <code>{{ expression }}</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">output</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span>
            <span class="nx">open</span><span class="o">:</span> <span class="s1">&#39;{{&#39;</span><span class="p">,</span>
            <span class="nx">close</span><span class="o">:</span> <span class="s1">&#39;}}&#39;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><em>Logic type tokens</em></p>

<p>These typically take a form like <code>{% if expression %}</code> or <code>{% endif %}</code></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">logic</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">logic</span><span class="p">,</span>
            <span class="nx">open</span><span class="o">:</span> <span class="s1">&#39;{%&#39;</span><span class="p">,</span>
            <span class="nx">close</span><span class="o">:</span> <span class="s1">&#39;%}&#39;</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><em>Comment type tokens</em></p>

<p>These take the form <code>{# anything #}</code></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">comment</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">comment</span><span class="p">,</span>
            <span class="nx">open</span><span class="o">:</span> <span class="s1">&#39;{#&#39;</span><span class="p">,</span>
            <span class="nx">close</span><span class="o">:</span> <span class="s1">&#39;#}&#39;</span>
        <span class="p">}</span>
    <span class="p">};</span>


    <span class="cm">/**</span>
<span class="cm">     * What characters start &quot;strings&quot; in token definitions. We need this to ignore token close</span>
<span class="cm">     * strings inside an expression.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">strings</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">];</span>

    <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">findStart</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">position</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                <span class="nx">def</span><span class="o">:</span> <span class="kc">null</span>
            <span class="p">},</span>
            <span class="nx">token_type</span><span class="p">,</span>
            <span class="nx">token_template</span><span class="p">,</span>
            <span class="nx">first_key_position</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">token_type</span> <span class="k">in</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">definitions</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">definitions</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">token_type</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">token_template</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">definitions</span><span class="p">[</span><span class="nx">token_type</span><span class="p">];</span>
                <span class="nx">first_key_position</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">token_template</span><span class="p">.</span><span class="nx">open</span><span class="p">);</span>

                <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.token.findStart: &quot;</span><span class="p">,</span> <span class="s2">&quot;Searching for &quot;</span><span class="p">,</span> <span class="nx">token_template</span><span class="p">.</span><span class="nx">open</span><span class="p">,</span> <span class="s2">&quot; found at &quot;</span><span class="p">,</span> <span class="nx">first_key_position</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Does this token occur before any other types?</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">first_key_position</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">output</span><span class="p">.</span><span class="nx">position</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">first_key_position</span> <span class="o">&lt;</span> <span class="nx">output</span><span class="p">.</span><span class="nx">position</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">first_key_position</span><span class="p">;</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">def</span> <span class="o">=</span> <span class="nx">token_template</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">findEnd</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">token_def</span><span class="p">,</span> <span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>String position variables</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">str_pos</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">str_found</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">pos</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">end_offset</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">this_str_pos</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">end_str_pos</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>For loop variables</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">i</span><span class="p">,</span>
            <span class="nx">l</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">str_pos</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="nx">str_found</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="nx">pos</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">token_def</span><span class="p">.</span><span class="nx">close</span><span class="p">,</span> <span class="nx">offset</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">end</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">;</span>
                <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>throw an exception</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unable to find closing bracket &#39;&quot;</span> <span class="o">+</span> <span class="nx">token_def</span><span class="p">.</span><span class="nx">close</span> <span class="o">+</span>
                                <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s2">&quot; opened near template position &quot;</span> <span class="o">+</span> <span class="nx">start</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nx">l</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">strings</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">this_str_pos</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">strings</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">offset</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">this_str_pos</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">this_str_pos</span> <span class="o">&lt;</span> <span class="nx">pos</span> <span class="o">&amp;&amp;</span>
                        <span class="p">(</span><span class="nx">str_pos</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">this_str_pos</span> <span class="o">&lt;</span> <span class="nx">str_pos</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">str_pos</span> <span class="o">=</span> <span class="nx">this_str_pos</span><span class="p">;</span>
                    <span class="nx">str_found</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">strings</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>We found a string before the end of the token, now find the string's end and set the search offset to it</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">str_pos</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">end_offset</span> <span class="o">=</span> <span class="nx">str_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="nx">end</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="nx">found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">end_str_pos</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">str_found</span><span class="p">,</span> <span class="nx">end_offset</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">end_str_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="s2">&quot;Unclosed string in template&quot;</span><span class="p">;</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Ignore escaped quotes</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">end_str_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;\\&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">offset</span> <span class="o">=</span> <span class="nx">end_str_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">end_offset</span> <span class="o">=</span> <span class="nx">end_str_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">end</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Convert a template into high-level tokens.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">tokenize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">[],</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>An offset for reporting errors locations in the template.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">error_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The start and type of the first token found in the template.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">found_token</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>The end position of the matched token.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">end</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Find the first occurance of any token type in the template</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">found_token</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">findStart</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>

            <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.tokenize: &quot;</span><span class="p">,</span> <span class="s2">&quot;Found token: &quot;</span><span class="p">,</span> <span class="nx">found_token</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">found_token</span><span class="p">.</span><span class="nx">position</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Add a raw type token for anything before the start of the token</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">found_token</span><span class="p">.</span><span class="nx">position</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                        <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">raw</span><span class="p">,</span>
                        <span class="nx">value</span><span class="o">:</span> <span class="nx">template</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">found_token</span><span class="p">.</span><span class="nx">position</span><span class="p">)</span>
                    <span class="p">});</span>
                <span class="p">}</span>
                <span class="nx">template</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">found_token</span><span class="p">.</span><span class="nx">position</span> <span class="o">+</span> <span class="nx">found_token</span><span class="p">.</span><span class="nx">def</span><span class="p">.</span><span class="nx">open</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
                <span class="nx">error_offset</span> <span class="o">+=</span> <span class="nx">found_token</span><span class="p">.</span><span class="nx">position</span> <span class="o">+</span> <span class="nx">found_token</span><span class="p">.</span><span class="nx">def</span><span class="p">.</span><span class="nx">open</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Find the end of the token</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">end</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">findEnd</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">found_token</span><span class="p">.</span><span class="nx">def</span><span class="p">,</span> <span class="nx">error_offset</span><span class="p">);</span>

                <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.tokenize: &quot;</span><span class="p">,</span> <span class="s2">&quot;Token ends at &quot;</span><span class="p">,</span> <span class="nx">end</span><span class="p">);</span>

                <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">found_token</span><span class="p">.</span><span class="nx">def</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">template</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">end</span><span class="p">).</span><span class="nx">trim</span><span class="p">()</span>
                <span class="p">});</span>

                <span class="nx">template</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">end</span> <span class="o">+</span> <span class="nx">found_token</span><span class="p">.</span><span class="nx">def</span><span class="p">.</span><span class="nx">close</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Increment the position in the template</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">error_offset</span> <span class="o">+=</span> <span class="nx">end</span> <span class="o">+</span> <span class="nx">found_token</span><span class="p">.</span><span class="nx">def</span><span class="p">.</span><span class="nx">close</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>No more tokens -> add the rest of the template as a raw-type token</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                    <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">raw</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">template</span>
                <span class="p">});</span>
                <span class="nx">template</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">tokens</span><span class="p">;</span>
    <span class="p">};</span>


    <span class="nx">Twig</span><span class="p">.</span><span class="nx">compile</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Output and intermediate stacks</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">stack</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">intermediate_output</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">token</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">logic_token</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">unclosed_token</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Temporary previous token.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">prev_token</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>The previous token's template</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">prev_template</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>The output token</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">tok_output</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Logic Token values</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">type</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">open</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">next</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Compiling token &quot;</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">raw</span><span class="o">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">intermediate_output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">logic</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Compile the logic token</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">logic_token</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">]);</span>

                    <span class="nx">type</span> <span class="o">=</span> <span class="nx">logic_token</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
                    <span class="nx">open</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">open</span><span class="p">;</span>
                    <span class="nx">next</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">next</span><span class="p">;</span>

                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Compiled logic token to &quot;</span><span class="p">,</span> <span class="nx">logic_token</span><span class="p">,</span>
                                                     <span class="s2">&quot; next is: &quot;</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="s2">&quot; open is : &quot;</span><span class="p">,</span> <span class="nx">open</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Not a standalone token, check logic stack to see if this is expected</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">open</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">open</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">prev_token</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                        <span class="nx">prev_template</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">prev_token</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">prev_template</span><span class="p">.</span><span class="nx">next</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot; not expected after a &quot;</span> <span class="o">+</span> <span class="nx">prev_token</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
                        <span class="p">}</span>

                        <span class="nx">prev_token</span><span class="p">.</span><span class="nx">output</span> <span class="o">=</span> <span class="nx">prev_token</span><span class="p">.</span><span class="nx">output</span> <span class="o">||</span> <span class="p">[];</span>

                        <span class="nx">prev_token</span><span class="p">.</span><span class="nx">output</span> <span class="o">=</span> <span class="nx">prev_token</span><span class="p">.</span><span class="nx">output</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">intermediate_output</span><span class="p">);</span>
                        <span class="nx">intermediate_output</span> <span class="o">=</span> <span class="p">[];</span>

                        <span class="nx">tok_output</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">logic</span><span class="p">,</span>
                            <span class="nx">token</span><span class="o">:</span> <span class="nx">prev_token</span>
                        <span class="p">};</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">intermediate_output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tok_output</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tok_output</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>This token requires additional tokens to complete the logic structure.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">next</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Pushing &quot;</span><span class="p">,</span> <span class="nx">logic_token</span><span class="p">,</span> <span class="s2">&quot; to logic stack.&quot;</span><span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Put any currently held output into the output list of the logic operator
currently at the head of the stack before we push a new one on.</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nx">prev_token</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                            <span class="nx">prev_token</span><span class="p">.</span><span class="nx">output</span> <span class="o">=</span> <span class="nx">prev_token</span><span class="p">.</span><span class="nx">output</span> <span class="o">||</span> <span class="p">[];</span>
                            <span class="nx">prev_token</span><span class="p">.</span><span class="nx">output</span> <span class="o">=</span> <span class="nx">prev_token</span><span class="p">.</span><span class="nx">output</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">intermediate_output</span><span class="p">);</span>
                            <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">prev_token</span><span class="p">);</span>
                        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Push the new logic token onto the logic stack</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">logic_token</span><span class="p">);</span>

                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">open</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">open</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">tok_output</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">logic</span><span class="p">,</span>
                            <span class="nx">token</span><span class="o">:</span> <span class="nx">logic_token</span>
                        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Standalone token (like {% set ... %}</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">intermediate_output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tok_output</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tok_output</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Do nothing, comments should be ignored</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">case</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">comment</span><span class="o">:</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">output</span><span class="o">:</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">]);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">intermediate_output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot; Output: &quot;</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span>
                                             <span class="s2">&quot; Logic Stack: &quot;</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span>
                                             <span class="s2">&quot; Pending Output: &quot;</span><span class="p">,</span> <span class="nx">intermediate_output</span> <span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Verify that there are no logic tokens left in the stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">unclosed_token</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unable to find an end tag for &quot;</span> <span class="o">+</span> <span class="nx">unclosed_token</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span>
                            <span class="s2">&quot;, expecting one of &quot;</span> <span class="o">+</span> <span class="nx">unclosed_token</span><span class="p">.</span><span class="nx">next</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Parse a compiled template.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Array} tokens The compiled tokens.</span>
<span class="cm">     * @param {Object} context The render context.</span>
<span class="cm">     *</span>
<span class="cm">     * @return {string} The parsed template.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">[],</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Track logic chains</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">chain</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Default to an empty object if none provided</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">||</span> <span class="p">{</span> <span class="p">};</span>

        <span class="nx">tokens</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Twig.parse: &quot;</span><span class="p">,</span> <span class="s2">&quot;Parsing token: &quot;</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>

            <span class="k">switch</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">raw</span><span class="o">:</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">logic</span><span class="o">:</span>
                    <span class="kd">var</span> <span class="nx">logic_token</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span>
                        <span class="nx">logic</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="p">[</span><span class="nx">logic_token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">]);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">logic</span><span class="p">.</span><span class="nx">chain</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">chain</span> <span class="o">=</span> <span class="nx">logic</span><span class="p">.</span><span class="nx">chain</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">logic</span><span class="p">.</span><span class="nx">context</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">context</span> <span class="o">=</span> <span class="nx">logic</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">logic</span><span class="p">.</span><span class="nx">output</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">logic</span><span class="p">.</span><span class="nx">output</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">comment</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Do nothing, comments should be ignored</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">output</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Parse the given expression in the given context</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]));</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">output</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Tokenize and compile a string template.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {string} data The template.</span>
<span class="cm">     *</span>
<span class="cm">     * @return {Array} The compiled tokens.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">prepare</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span><span class="p">,</span> <span class="nx">raw_tokens</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Tokenize</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Twig.prepare: &quot;</span><span class="p">,</span> <span class="s2">&quot;Tokenizing &quot;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="nx">raw_tokens</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">data</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Compile</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Twig.prepare: &quot;</span><span class="p">,</span> <span class="s2">&quot;Compiling &quot;</span><span class="p">,</span> <span class="nx">raw_tokens</span><span class="p">);</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">raw_tokens</span><span class="p">]);</span>

        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Twig.prepare: &quot;</span><span class="p">,</span> <span class="s2">&quot;Compiled &quot;</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">tokens</span><span class="p">;</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Namespace for template storage and retrieval</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">registry</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Save a template object to the store.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Twig.Template} template   The twig.js template to store.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span><span class="p">.</span><span class="nx">save</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unable to save template with no id&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span><span class="p">.</span><span class="nx">registry</span><span class="p">[</span><span class="nx">template</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">template</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Load a previously saved template from the store.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {string} id   The ID of the template to load.</span>
<span class="cm">     *</span>
<span class="cm">     * @return {Twig.Template} A twig.js template stored with the provided ID.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span><span class="p">.</span><span class="nx">load</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span><span class="p">.</span><span class="nx">registry</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Load a template from a remote location using AJAX and saves in with the given ID.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {string} url  The remote URL to load as a template.</span>
<span class="cm">     * @param {Object} params The template parameters.</span>
<span class="cm">     * @param {function} callback  A callback triggered when the template finishes loading.</span>
<span class="cm">     * @param {boolean} async  Should the HTTP request be performed asynchronously. Defaults to true.</span>
<span class="cm">     *</span>
<span class="cm">     *</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span><span class="p">.</span><span class="nx">loadRemote</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">async</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span>          <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
            <span class="nx">blocks</span>      <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">blocks</span><span class="p">,</span>
            <span class="nx">precompiled</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">precompiled</span><span class="p">,</span>
            <span class="nx">template</span>    <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Default to the URL so the template is cached.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">id</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">id</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Check for existing template</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>A template is already saved with the given id.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">return</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">XMLHttpRequest</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unsupported platform: Unable to do remote requests &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;because there is no XMLHTTPRequest implementation&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">xmlhttp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
        <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Got template &quot;</span><span class="p">,</span> <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Get the template</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">precompiled</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
                    <span class="nx">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">Template</span><span class="p">({</span>
                        <span class="nx">data</span><span class="o">:</span> <span class="nx">tokens</span><span class="p">,</span>
                        <span class="nx">blocks</span><span class="o">:</span> <span class="nx">blocks</span><span class="p">,</span>
                        <span class="nx">id</span><span class="o">:</span>   <span class="nx">id</span>
                    <span class="p">});</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">template</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">Template</span><span class="p">({</span>
                        <span class="nx">data</span><span class="o">:</span> <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">responseText</span><span class="p">,</span>
                        <span class="nx">blocks</span><span class="o">:</span> <span class="nx">blocks</span><span class="p">,</span>
                        <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span>
                    <span class="p">});</span>
                    <span class="nx">template</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">callback</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">async</span> <span class="o">===</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">async</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">template</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Determine object type</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">is</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">clas</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">obj</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">clas</span> <span class="o">===</span> <span class="nx">type</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Create a new twig.js template.</span>
<span class="cm">     *</span>
<span class="cm">     * Parameters: {</span>
<span class="cm">     *      data:   The template, either pre-compiled tokens or a string template</span>
<span class="cm">     *      id:     The name of this template</span>
<span class="cm">     *      blocks: Any pre-existing block from a child template</span>
<span class="cm">     * }</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Object} params The template parameters.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">Template</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">params</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span>
            <span class="nx">id</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
            <span class="nx">blocks</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">blocks</span><span class="p">,</span>
            <span class="nx">url</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <h1>What is stored in a Twig.Template</h1>

<p>The Twig Template hold several chucks of data.</p>

<pre><code>{
     id:     The token ID (if any)
     tokens: The list of tokens that makes up this template.
     blocks: The list of block this template contains.
     base:   The base template (if any)
}
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">id</span>     <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span> <span class="o">=</span> <span class="nx">blocks</span> <span class="o">||</span> <span class="p">{};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;String&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">tokens</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">prepare</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">data</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">tokens</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
                <span class="nx">output</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Should the output be an object with the blocks</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">blocks</span> <span class="o">=</span> <span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="nx">params</span><span class="p">.</span><span class="nx">output</span> <span class="o">==</span> <span class="s1">&#39;blocks&#39;</span><span class="p">;</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">importBlocks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">override</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">relativePath</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">file</span><span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Load blocks from an external file</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">sub_template</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span><span class="p">.</span><span class="nx">loadRemote</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
                        <span class="nx">id</span><span class="o">:</span> <span class="nx">url</span>
                    <span class="p">},</span> <span class="kc">false</span><span class="p">),</span>
                    <span class="nx">key</span><span class="p">;</span>

                <span class="nx">override</span> <span class="o">=</span> <span class="nx">override</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>

                <span class="nx">sub_template</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Mixin blocks</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">sub_template</span><span class="p">.</span><span class="nx">blocks</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">override</span> <span class="o">||</span> <span class="nx">that</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sub_template</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">};</span>

            <span class="nx">output</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Does this template extend another</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">extend</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">url</span> <span class="o">=</span> <span class="nx">relativePath</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">extend</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>This template extends another, load it with this template's blocks</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span><span class="p">.</span><span class="nx">loadRemote</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">id</span><span class="o">:</span>     <span class="nx">url</span><span class="p">,</span>
                    <span class="nx">blocks</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span>
                <span class="p">},</span> <span class="kc">false</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Pass the parsed blocks to the parent.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">blocks</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">;</span>

                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">blocks</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">id</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">Templates</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Generate the relative canonical version of a url based on the given base path and file path.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {string} base The base path.</span>
<span class="cm">     * @param {string} file The file path, relative to the base path.</span>
<span class="cm">     *</span>
<span class="cm">     * @return {string} The canonical version of the path.</span>
<span class="cm">     */</span>
    <span class="kd">function</span> <span class="nx">relativePath</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sep_chr</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
            <span class="nx">base_path</span> <span class="o">=</span> <span class="nx">base</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">sep_chr</span><span class="p">),</span>
            <span class="nx">new_path</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">val</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Remove file from url</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">base_path</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
        <span class="nx">base_path</span> <span class="o">=</span> <span class="nx">base_path</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">sep_chr</span><span class="p">));</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">base_path</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">val</span> <span class="o">=</span> <span class="nx">base_path</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Ignore</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">==</span> <span class="s2">&quot;..&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">new_path</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">new_path</span><span class="p">[</span><span class="nx">new_path</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;..&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">new_path</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">new_path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">new_path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">sep_chr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">Twig</span><span class="p">;</span>

<span class="p">})</span> <span class="p">(</span><span class="nx">Twig</span> <span class="o">||</span> <span class="p">{</span> <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>The following methods are from MDN and are available under a
<a href="http://creativecommons.org/licenses/by-sa/2.5/">Creative Commons Attribution-ShareAlike 2.5 License.</a></p>

<p>See:</p>

<ul>
<li><a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/indexOf">Array.indexOf - MDN</a></li>
<li><a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/forEach">Array.forEach - MDN</a></li>
<li><a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object/keys">Object.keys - MDN</a></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <h2>twig.fills.js</h2>

<p>This file contains fills for backwards compatability.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Handle methods that don't yet exist in every browser</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">searchElement</span> <span class="cm">/*, fromIndex */</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="o">===</span> <span class="k">void</span> <span class="mi">0</span> <span class="o">||</span> <span class="k">this</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">n</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">!==</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// shortcut for verifying if it&#39;s NaN</span>
                    <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="o">!==</span> <span class="kc">Infinity</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="o">!==</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">n</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">n</span><span class="p">));</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;=</span> <span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">n</span> <span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">len</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">n</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(;</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">t</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">===</span> <span class="nx">searchElement</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">k</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Production steps of ECMA-262, Edition 5, 15.4.4.18
Reference: http://es5.github.com/#x15.4.4.18</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">forEach</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">thisArg</span> <span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">T</span><span class="p">,</span> <span class="nx">k</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="k">this</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span> <span class="s2">&quot; this is null or not defined&quot;</span> <span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <ol>
<li>Let O be the result of calling ToObject passing the |this| value as the argument.</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">O</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <ol>
<li>Let lenValue be the result of calling the Get internal method of O with the argument "length".</li>
<li>Let len be ToUint32(lenValue).</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">O</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// Hack to convert O.length to a UInt32</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <ol>
<li>If IsCallable(callback) is false, throw a TypeError exception.
See: http://es5.github.com/#x9.11</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="p">{}.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;[object Function]&quot;</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span> <span class="nx">callback</span> <span class="o">+</span> <span class="s2">&quot; is not a function&quot;</span> <span class="p">);</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <ol>
<li>If thisArg was supplied, let T be thisArg; else let T be undefined.</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="nx">thisArg</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">T</span> <span class="o">=</span> <span class="nx">thisArg</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <ol>
<li>Let k be 0</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <ol>
<li>Repeat, while k &lt; len</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">while</span><span class="p">(</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="p">)</span> <span class="p">{</span>

          <span class="kd">var</span> <span class="nx">kValue</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>a. Let Pk be ToString(k).
  This is implicit for LHS operands of the in operator
b. Let kPresent be the result of calling the HasProperty internal method of O with argument Pk.
  This step can be combined with c
c. If kPresent is true, then</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">O</span> <span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>i. Let kValue be the result of calling the Get internal method of O with argument Pk.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">kValue</span> <span class="o">=</span> <span class="nx">O</span><span class="p">[</span> <span class="nx">k</span> <span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>ii. Call the Call internal method of callback with T as the this value and
argument list containing kValue, k, and O.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">T</span><span class="p">,</span> <span class="nx">kValue</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">O</span> <span class="p">);</span>
          <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>d. Increase k by 1.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">k</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <ol>
<li>return undefined</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">};</span>
    <span class="p">};</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">)</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">o</span> <span class="o">!==</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">o</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Object.keys called on non-object&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">p</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">p</span> <span class="k">in</span> <span class="nx">o</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">p</span><span class="p">))</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">})();</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <pre><code>Twig.js v0.3
Copyright (c) 2011 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <h2>twig.logic.js</h2>

<p>This file handles tokenizing, compiling and parsing logic tokens. {% ... %}</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Twig</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Namespace for logic handling.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="cm">/**</span>
<span class="cm">     * Logic token types.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">if_</span><span class="o">:</span>       <span class="s1">&#39;Twig.logic.type.if&#39;</span><span class="p">,</span>
        <span class="nx">endif</span><span class="o">:</span>     <span class="s1">&#39;Twig.logic.type.endif&#39;</span><span class="p">,</span>
        <span class="nx">for_</span><span class="o">:</span>      <span class="s1">&#39;Twig.logic.type.for&#39;</span><span class="p">,</span>
        <span class="nx">endfor</span><span class="o">:</span>    <span class="s1">&#39;Twig.logic.type.endfor&#39;</span><span class="p">,</span>
        <span class="nx">else_</span><span class="o">:</span>     <span class="s1">&#39;Twig.logic.type.else&#39;</span><span class="p">,</span>
        <span class="nx">elseif</span><span class="o">:</span>    <span class="s1">&#39;Twig.logic.type.elseif&#39;</span><span class="p">,</span>
        <span class="nx">set</span><span class="o">:</span>       <span class="s1">&#39;Twig.logic.type.set&#39;</span><span class="p">,</span>
        <span class="nx">filter</span><span class="o">:</span>    <span class="s1">&#39;Twig.logic.type.filter&#39;</span><span class="p">,</span>
        <span class="nx">endfilter</span><span class="o">:</span> <span class="s1">&#39;Twig.logic.type.endfilter&#39;</span><span class="p">,</span>
        <span class="nx">block</span><span class="o">:</span>     <span class="s1">&#39;Twig.logic.type.block&#39;</span><span class="p">,</span>
        <span class="nx">endblock</span><span class="o">:</span>  <span class="s1">&#39;Twig.logic.type.endblock&#39;</span><span class="p">,</span>
        <span class="nx">extends_</span><span class="o">:</span>  <span class="s1">&#39;Twig.logic.type.extends&#39;</span><span class="p">,</span>
        <span class="nx">use</span><span class="o">:</span>       <span class="s1">&#39;Twig.logic.type.use&#39;</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Regular expressions for handling logic tokens.</p>

<p>Properties:</p>

<pre><code> type:  The type of expression this matches

 regex: A regular expression that matches the format of the token

 next:  What logic tokens (if any) pop this token off the logic stack. If empty, the
        logic token is assumed to not require an end tag and isn't push onto the stack.

 open:  Does this tag open a logic expression or is it standalone. For example,
        {% endif %} cannot exist without an opening {% if ... %} tag, so open = false.
</code></pre>

<p>Functions:</p>

<pre><code> compile: A function that handles compiling the token into an output token ready for
          parsing with the parse function.

 parse:   A function that parses the compiled token into output (HTML / whatever the
          template represents).
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">definitions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * If type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% if expression %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">if_</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^if\s+([^\s].+)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">else_</span><span class="p">,</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">elseif</span><span class="p">,</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endif</span>
            <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Compile the expression.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">token</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Parse the expression</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">result</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Start a new logic chain</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">chain</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">chain</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>parse if output</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">output</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="nx">output</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Else if type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% elseif expression %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">elseif</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^elseif\s+([^\s].*)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">else_</span><span class="p">,</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endif</span>
            <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Compile the expression.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">token</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">chain</span> <span class="o">&amp;&amp;</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">])</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">chain</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>parse if output</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">output</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="nx">output</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Else if type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% elseif expression %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">else_</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^else$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endif</span><span class="p">,</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endfor</span>
            <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">output</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="nx">output</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * End if type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% endif %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endif</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^endif$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * For type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% for expression %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">for_</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^for\s+([a-zA-Z0-9_,\s]+)\s+in\s+([^\s].+)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">else_</span><span class="p">,</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endfor</span>
            <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">key_value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="nx">expression</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="nx">kv_split</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
                    <span class="nx">expression_stack</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                <span class="nx">token</span><span class="p">.</span><span class="nx">key_var</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">value_var</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">key_value</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">kv_split</span> <span class="o">=</span> <span class="nx">key_value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">kv_split</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">token</span><span class="p">.</span><span class="nx">key_var</span> <span class="o">=</span> <span class="nx">kv_split</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span>
                        <span class="nx">token</span><span class="p">.</span><span class="nx">value_var</span> <span class="o">=</span> <span class="nx">kv_split</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid expression in for loop: &quot;</span> <span class="o">+</span> <span class="nx">key_value</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">token</span><span class="p">.</span><span class="nx">value_var</span> <span class="o">=</span> <span class="nx">key_value</span><span class="p">;</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Valid expressions for a for loop
  for item     in expression
  for key,item in expression</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Compile the expression.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">expression_stack</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>

                <span class="nx">token</span><span class="p">.</span><span class="nx">expression</span> <span class="o">=</span> <span class="nx">expression_stack</span><span class="p">;</span>

                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">continue_chain</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Parse expression</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span> <span class="nx">context</span><span class="p">]),</span>
                    <span class="nx">output</span> <span class="o">=</span> <span class="p">[],</span>
                    <span class="nx">key</span><span class="p">,</span>
                    <span class="nx">keyset</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="nx">result</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">context</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">value_var</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">key_var</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">context</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">key_var</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">context</span><span class="p">]));</span>

                        <span class="nx">key</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">});</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="k">instanceof</span> <span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">keyset</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">_keys</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">keyset</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="nx">keyset</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s2">&quot;_keys&quot;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// Ignore the _keys property</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
                            <span class="nx">context</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">value_var</span><span class="p">]</span> <span class="o">=</span> <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">key_var</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">context</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">key_var</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
                            <span class="p">}</span>
                            <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">context</span><span class="p">]));</span>
                        <span class="p">}</span>
                    <span class="p">});</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Only allow else statements if no output was generated</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">continue_chain</span> <span class="o">=</span> <span class="p">(</span><span class="nx">output</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">continue_chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="nx">output</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * End if type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% endif %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endfor</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^endfor$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Set type logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% set key = expression %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">set</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^set\s+([a-zA-Z0-9_,\s]+)\s*=\s*(.+)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">(),</span>
                    <span class="nx">expression</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Compile the expression.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">expression_stack</span>  <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                        <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                        <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                    <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>

                <span class="nx">token</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">expression</span> <span class="o">=</span> <span class="nx">expression_stack</span><span class="p">;</span>

                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">continue_chain</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span> <span class="nx">context</span><span class="p">]),</span>
                    <span class="nx">key</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>

                <span class="nx">context</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">continue_chain</span><span class="p">,</span>
                    <span class="nx">context</span><span class="o">:</span> <span class="nx">context</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Filter logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% filter upper %} or {% filter lower|escape %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">filter</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^filter\s+(.+)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endfilter</span>
            <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Compile the expression.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">token</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">unfiltered</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">context</span><span class="p">]),</span>
                    <span class="nx">stack</span> <span class="o">=</span> <span class="p">[{</span>
                        <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span>
                        <span class="nx">value</span><span class="o">:</span> <span class="nx">unfiltered</span>
                    <span class="p">}].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>

                <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="nx">output</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * End filter logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% endfilter %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endfilter</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^endfilter$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Block logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% block title %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">block</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^block\s+([a-zA-Z0-9_]+)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endblock</span>
            <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">block</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">block_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="nx">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Don't ovverride previous blocks</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">block</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">block_output</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                        <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span>
                        <span class="nx">value</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">output</span><span class="p">,</span> <span class="nx">context</span><span class="p">])</span>
                    <span class="p">},</span> <span class="nx">context</span><span class="p">]);</span>

                    <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">block</span><span class="p">]</span> <span class="o">=</span> <span class="nx">block_output</span><span class="p">;</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>This is the base template -> append to output</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">extend</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">output</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">blocks</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">block</span><span class="p">];</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="nx">output</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * End filter logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% endfilter %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">endblock</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^endblock$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Block logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% extends &quot;template.twig&quot; %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">extends_</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^extends\s+(.+)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>

                <span class="nx">token</span><span class="p">.</span><span class="nx">stack</span>   <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>

                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Resolve filename</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Set parent template</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">file</span><span class="p">;</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Block logic tokens.</span>
<span class="cm">             *</span>
<span class="cm">             *  Format: {% extends &quot;template.twig&quot; %}</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">use</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^use\s+(.+)$/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="p">[</span> <span class="p">],</span>
            <span class="nx">open</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">trim</span><span class="p">();</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>

                <span class="nx">token</span><span class="p">.</span><span class="nx">stack</span>   <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[{</span>
                    <span class="nx">type</span><span class="o">:</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">expression</span>
                <span class="p">}]).</span><span class="nx">stack</span><span class="p">;</span>

                <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Resolve filename</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Import blocks</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">importBlocks</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nx">chain</span><span class="o">:</span> <span class="nx">chain</span><span class="p">,</span>
                    <span class="nx">output</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
                <span class="p">};</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">];</span>

    <span class="cm">/**</span>
<span class="cm">     * Registry for logic handlers.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="cm">/**</span>
<span class="cm">     * Define a new token type, available at Twig.logic.type.{type}</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">extendType</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span> <span class="o">||</span> <span class="p">(</span><span class="s2">&quot;Twig.logic.type&quot;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">);</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Extend the logic parsing functionality with a new token definition.</span>
<span class="cm">     *</span>
<span class="cm">     * // Define a new tag</span>
<span class="cm">     * Twig.logic.extend({</span>
<span class="cm">     *     type: Twig.logic.type.{type},</span>
<span class="cm">     *     // The pattern to match for this token</span>
<span class="cm">     *     regex: ...,</span>
<span class="cm">     *     // What token types can follow this token, leave blank if any.</span>
<span class="cm">     *     next: [ ... ]</span>
<span class="cm">     *     // Create and return compiled version of the token</span>
<span class="cm">     *     compile: function(token) { ... }</span>
<span class="cm">     *     // Parse the compiled token with the context provided by the render call</span>
<span class="cm">     *     //   and whether this token chain is complete.</span>
<span class="cm">     *     parse: function(token, context, chain) { ... }</span>
<span class="cm">     * });</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Object} definition The new logic expression.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">definition</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">definition</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unable to extend logic definition. No type provided for &quot;</span> <span class="o">+</span> <span class="nx">definition</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">type</span><span class="p">[</span><span class="nx">definition</span><span class="p">.</span><span class="nx">type</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unable to extend logic definitions. Type &quot;</span> <span class="o">+</span>
                                 <span class="nx">definition</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot; is already defined.&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">extendType</span><span class="p">(</span><span class="nx">definition</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">definition</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">definition</span><span class="p">;</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Extend with built-in expressions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">definitions</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">definitions</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Compile a logic token into an object ready for parsing.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Object} raw_token An uncompiled logic token.</span>
<span class="cm">     *</span>
<span class="cm">     * @return {Object} A compiled logic token, ready for parsing.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">compile</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">raw_token</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">raw_token</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">trim</span><span class="p">(),</span>
            <span class="nx">token</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">expression</span><span class="p">]),</span>
            <span class="nx">token_template</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Check if the token needs compiling</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">token_template</span><span class="p">.</span><span class="nx">compile</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">token</span> <span class="o">=</span> <span class="nx">token_template</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">]);</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.logic.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Compiled logic token to &quot;</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Tokenize logic expressions. This function matches token expressions against regular</span>
<span class="cm">     * expressions provided in token definitions provided with Twig.logic.extend.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {string} expression the logic token expression to tokenize</span>
<span class="cm">     *                (i.e. what&#39;s between {% and %})</span>
<span class="cm">     *</span>
<span class="cm">     * @return {Object} The matched token with type set to the token type and match to the regex match.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">tokenize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">expression</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">token_template_type</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">token_type</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">token_regex</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">regex_array</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">regex</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">match</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Ignore whitespace around expressions.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">expression</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">token_template_type</span> <span class="k">in</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">token_template_type</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Get the type and regex for this template type</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">token_type</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">token_template_type</span><span class="p">].</span><span class="nx">type</span><span class="p">;</span>
                <span class="nx">token_regex</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">token_template_type</span><span class="p">].</span><span class="nx">regex</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Handle multiple regular expressions per type.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">regex_array</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">token_regex</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">regex_array</span> <span class="o">=</span> <span class="nx">token_regex</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">regex_array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token_regex</span><span class="p">);</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Check regular expressions in the order they were specified in the definition.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">while</span> <span class="p">(</span><span class="nx">regex_array</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">regex</span> <span class="o">=</span> <span class="nx">regex_array</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
                    <span class="nx">match</span> <span class="o">=</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">expression</span><span class="p">.</span><span class="nx">trim</span><span class="p">());</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">match</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">token</span><span class="p">.</span><span class="nx">type</span>  <span class="o">=</span> <span class="nx">token_type</span><span class="p">;</span>
                        <span class="nx">token</span><span class="p">.</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">match</span><span class="p">;</span>
                        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.logic.tokenize: &quot;</span><span class="p">,</span> <span class="s2">&quot;Matched a &quot;</span><span class="p">,</span> <span class="nx">token_type</span><span class="p">,</span> <span class="s2">&quot; regular expression of &quot;</span><span class="p">,</span> <span class="nx">match</span><span class="p">);</span>
                        <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>No regex matches</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unable to parse &#39;&quot;</span> <span class="o">+</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Parse a logic token within a given context.</span>
<span class="cm">     *</span>
<span class="cm">     * What are logic chains?</span>
<span class="cm">     *      Logic chains represent a series of tokens that are connected,</span>
<span class="cm">     *          for example:</span>
<span class="cm">     *          {% if ... %} {% else %} {% endif %}</span>
<span class="cm">     *</span>
<span class="cm">     *      The chain parameter is used to signify if a chain is open of closed.</span>
<span class="cm">     *      open:</span>
<span class="cm">     *          More tokens in this chain should be parsed.</span>
<span class="cm">     *      closed:</span>
<span class="cm">     *          This token chain has completed parsing and any additional</span>
<span class="cm">     *          tokens (else, elseif, etc...) should be ignored.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Object} token The compiled token.</span>
<span class="cm">     * @param {Object} context The render context.</span>
<span class="cm">     * @param {boolean} chain Is this an open logic chain. If false, that means a</span>
<span class="cm">     *                        chain is closed and no further cases should be parsed.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="nx">token_template</span><span class="p">;</span>

        <span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span> <span class="o">||</span> <span class="p">{</span> <span class="p">};</span>

        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Twig.logic.parse: &quot;</span><span class="p">,</span> <span class="s2">&quot;Parsing logic token &quot;</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>

        <span class="nx">token_template</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">logic</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">token_template</span><span class="p">.</span><span class="nx">parse</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span> <span class="o">=</span> <span class="nx">token_template</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">chain</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">Twig</span><span class="p">;</span>

<span class="p">})(</span><span class="nx">Twig</span> <span class="o">||</span> <span class="p">{</span> <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <pre><code>Twig.js v0.3
Copyright (c) 2011 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <h2>twig.expression.js</h2>

<p>This file handles tokenizing, compiling and parsing expressions.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Twig</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Namespace for expression handling.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * The type of tokens used in expressions.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">comma</span><span class="o">:</span>      <span class="s1">&#39;Twig.expression.type.comma&#39;</span><span class="p">,</span>
        <span class="nx">expression</span><span class="o">:</span> <span class="s1">&#39;Twig.expression.type.expression&#39;</span><span class="p">,</span>
        <span class="nx">operator</span><span class="o">:</span>   <span class="s1">&#39;Twig.expression.type.operator&#39;</span><span class="p">,</span>
        <span class="nx">string</span><span class="o">:</span>     <span class="s1">&#39;Twig.expression.type.string&#39;</span><span class="p">,</span>
        <span class="nx">array</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">start</span><span class="o">:</span>  <span class="s1">&#39;Twig.expression.type.array.start&#39;</span><span class="p">,</span>
            <span class="nx">end</span><span class="o">:</span>    <span class="s1">&#39;Twig.expression.type.array.end&#39;</span>
        <span class="p">},</span>
        <span class="nx">object</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">start</span><span class="o">:</span>  <span class="s1">&#39;Twig.expression.type.object.start&#39;</span><span class="p">,</span>
            <span class="nx">end</span><span class="o">:</span>    <span class="s1">&#39;Twig.expression.type.object.end&#39;</span>
        <span class="p">},</span>
        <span class="nx">parameter</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">start</span><span class="o">:</span>  <span class="s1">&#39;Twig.expression.type.parameter.start&#39;</span><span class="p">,</span>
            <span class="nx">end</span><span class="o">:</span>    <span class="s1">&#39;Twig.expression.type.parameter.end&#39;</span>
        <span class="p">},</span>
        <span class="nx">key</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">period</span><span class="o">:</span>   <span class="s1">&#39;Twig.expression.type.key.period&#39;</span><span class="p">,</span>
            <span class="nx">brackets</span><span class="o">:</span> <span class="s1">&#39;Twig.expression.type.key.brackets&#39;</span>
        <span class="p">},</span>
        <span class="nx">filter</span><span class="o">:</span>     <span class="s1">&#39;Twig.expression.type.filter&#39;</span><span class="p">,</span>
        <span class="nx">variable</span><span class="o">:</span>   <span class="s1">&#39;Twig.expression.type.variable&#39;</span><span class="p">,</span>
        <span class="nx">number</span><span class="o">:</span>     <span class="s1">&#39;Twig.expression.type.number&#39;</span><span class="p">,</span>
        <span class="nx">setkey</span><span class="o">:</span>     <span class="s1">&#39;Twig.expression.type.setkey&#39;</span><span class="p">,</span>
        <span class="nx">test</span><span class="o">:</span>     <span class="s1">&#39;Twig.expression.type.test&#39;</span>
    <span class="p">};</span>

    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>What can follow an expression (in general)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">operations</span><span class="o">:</span> <span class="p">[</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">filter</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">operator</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">comma</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">setkey</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">test</span>
        <span class="p">],</span>
        <span class="nx">expressions</span><span class="o">:</span> <span class="p">[</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">variable</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">number</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span>
            <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">start</span>
        <span class="p">]</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Some commonly used compile and parse functions.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">compile</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">push</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">parse</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">push</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">push_value</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>The regular expressions and compile/parse logic used to match tokens in expressions.</p>

<p>Properties:</p>

<pre><code> type:  The type of expression this matches

 regex: One or more regular expressions that matche the format of the token.

 next:  Valid tokens that can occur next in the expression.
</code></pre>

<p>Functions:</p>

<pre><code> compile: A function that compiles the raw regular expression match into a token.

 parse:   A function that parses the compiled token into output.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">definitions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">test</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^is\s+(not)?\s*([a-zA-Z_][a-zA-Z0-9_]*)/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">filter</span>   <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">modifier</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span>
                    <span class="nx">params</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span> <span class="nx">context</span><span class="p">]),</span>
                    <span class="nx">result</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">filter</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">modifier</span> <span class="o">==</span> <span class="s1">&#39;not&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">setkey</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\:/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">expressions</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">key_token</span> <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">key_token</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unexpected object key: &quot;</span> <span class="o">+</span> <span class="nx">key_token</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key_token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">push</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">comma</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Match a comma</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^,/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">expressions</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">while</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="p">}</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">expression</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Match (, anything but ), )</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\(([^\)]+)\)/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

                <span class="kd">var</span> <span class="nx">sub_stack</span> <span class="o">=</span>  <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">token</span><span class="p">).</span><span class="nx">stack</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span><span class="nx">sub_stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">sub_stack</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">operator</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>Match any of +, *, /, -,^, ~, !, &lt;, &lt;=, >, >=, !=, ==, ||, &amp;&amp;</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/(^[\+\*\/\-\^~%]|^[&lt;&gt;!]=?|^==|^\|\||^&amp;&amp;)/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">expressions</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
                    <span class="nx">operator</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>

                <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Operator: &quot;</span><span class="p">,</span> <span class="nx">operator</span><span class="p">);</span>

                <span class="k">while</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
                            <span class="p">(</span><span class="nx">operator</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">leftToRight</span> <span class="o">&amp;&amp;</span>
                             <span class="nx">operator</span><span class="p">.</span><span class="nx">precidence</span>    <span class="o">&gt;=</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">precidence</span><span class="p">)</span> <span class="o">||</span>

                            <span class="p">(</span><span class="nx">operator</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">rightToLeft</span> <span class="o">&amp;&amp;</span>
                             <span class="nx">operator</span><span class="p">.</span><span class="nx">precidence</span>    <span class="o">&gt;</span>  <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">precidence</span><span class="p">))</span>
                       <span class="p">)</span> <span class="p">{</span>
                     <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="p">}</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">operator</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">stack</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match a string. This is anything between a pair of single or double quotes.</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>See: http://blog.stevenlevithan.com/archives/match-quoted-string</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^([&quot;&#39;])(?:(?=(\\?))\2.)*?\1/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Remove the quotes from the string</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;\\&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;\\&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;String value: &quot;</span><span class="p">,</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">push_value</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match a parameter set start.</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\(/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">end</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">push</span><span class="p">,</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">push</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match a parameter set end.</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\)/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">while</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Move contents of parens into preceding filter</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">param_stack</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">while</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>Add token to arguments stack</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">param_stack</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
                    <span class="nx">token</span> <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="nx">param_stack</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>Get the token preceding the parameters</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">token</span> <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">filter</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">test</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Expected filter before parameters, got &quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="nx">param_stack</span><span class="p">;</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">new_array</span> <span class="o">=</span> <span class="p">[],</span>
                    <span class="nx">array_ended</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                <span class="k">while</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>Push values into the array until the start of the array</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">array_ended</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">new_array</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">array_ended</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Expected end of parameter set.&quot;</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">new_array</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match an array start.</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\[/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">end</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">push</span><span class="p">,</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">push</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match an array end.</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\]/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">period</span><span class="p">,</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">brackets</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">while</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="p">}</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">new_array</span> <span class="o">=</span> <span class="p">[],</span>
                    <span class="nx">array_ended</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                <span class="k">while</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Push values into the array until the start of the array</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">array</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">array_ended</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">new_array</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">array_ended</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Expected end of array.&quot;</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">new_array</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>Token that represents the start of a hash map '}'</p>

<p>Hash maps take the form:
   { "key": 'value', "another_key": item }</p>

<p>Keys must be quoted (either single or double) and values can be any expression.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">start</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\{/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">end</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">push</span><span class="p">,</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">push</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>Token that represents the end of a Hash Map '}'</p>

<p>This is where the logic for building the internal
representation of a hash map is defined.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\}/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">period</span><span class="p">,</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">brackets</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">while</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="p">}</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">end_token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">new_object</span> <span class="o">=</span> <span class="p">{},</span>
                    <span class="nx">object_ended</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
                    <span class="nx">token</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                <span class="k">while</span> <span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">token</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>Push values into the array until the start of the object</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">object_ended</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">setkey</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Expected value for key &quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">.</span><span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot; in object definition. Got &quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="nx">new_object</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>Preserve the order that elements are added to the map
This is necessary since JavaScript objects don't
guarantee the order of keys</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="nx">new_object</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">new_object</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="nx">new_object</span><span class="p">.</span><span class="nx">_keys</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>

                        <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">object_ended</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unexpected end of object.&quot;</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">new_object</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>Token representing a filter</p>

<p>Filters can follow any expression and take the form:
   expression|filter(optional, args)</p>

<p>Filter parsing is done in the Twig.filters namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">filter</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>match a | then a letter or _, then any number of letters, numbers, _ or -</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\|[a-zA-Z_][a-zA-Z0-9_\-]*/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">period</span><span class="p">,</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">brackets</span><span class="p">,</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">parameter</span><span class="p">.</span><span class="nx">start</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span>
                    <span class="nx">params</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span>

                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">params</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>Token representing a variable.</p>

<p>Variables can contain letters, numbers, underscores and
dashes, but must start with a letter or underscore.</p>

<p>Variables are retrieved from the render context and take
the value of 'undefined' if the given variable doesn't
exist in the context.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">variable</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>match any letter or _, then any number of letters, numbers, _ or -</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^[a-zA-Z_][a-zA-Z0-9_]*/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">period</span><span class="p">,</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">brackets</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">push</span><span class="p">,</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>Get the variable from the context</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">period</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\.([a-zA-Z_][a-zA-Z0-9_]*)/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">period</span><span class="p">,</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">brackets</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span>
                    <span class="nx">object</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">object</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">object</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t access a key &quot;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot; on an undefined object.&quot;</span><span class="p">);</span>
                <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>Get the variable from the context</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">object</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">brackets</span><span class="p">,</span>
            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\[([^\]]*)\]/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">period</span><span class="p">,</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">brackets</span><span class="p">]),</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
                <span class="k">delete</span> <span class="nx">token</span><span class="p">.</span><span class="nx">match</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>The expression stack for the key</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">token</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span><span class="p">({</span>
                    <span class="nx">value</span><span class="o">:</span> <span class="nx">match</span>
                <span class="p">}).</span><span class="nx">stack</span><span class="p">;</span>

                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>Evaluate key</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]),</span>
                    <span class="nx">object</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Get the variable from the context</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">object</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Model doesn&#39;t provide the key &quot;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">object</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="cm">/**</span>
<span class="cm">             * Match a number (integer or decimal)</span>
<span class="cm">             */</span>
            <span class="nx">type</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">number</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>match a number</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">regex</span><span class="o">:</span> <span class="sr">/^\-?\d*\.?\d+/</span><span class="p">,</span>
            <span class="nx">next</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">operations</span><span class="p">,</span>
            <span class="nx">compile</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">push</span><span class="p">,</span>
            <span class="nx">parse</span><span class="o">:</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">push_value</span>
        <span class="p">}</span>
    <span class="p">];</span>

    <span class="cm">/**</span>
<span class="cm">     * Resolve a context value.</span>
<span class="cm">     *</span>
<span class="cm">     * If the value is a function, it is executed with a context parameter.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {string} key The context object key.</span>
<span class="cm">     * @param {Object} context The render context.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">resolve</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">context</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="p">[</span><span class="nx">context</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Registry for logic handlers.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="cm">/**</span>
<span class="cm">     * Define a new expression type, available at Twig.logic.type.{type}</span>
<span class="cm">     *</span>
<span class="cm">     * @param {string} type The name of the new type.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">extendType</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">type</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Twig.expression.type.&quot;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Extend the expression parsing functionality with a new definition.</span>
<span class="cm">     *</span>
<span class="cm">     * Token definitions follow this format:</span>
<span class="cm">     *  {</span>
<span class="cm">     *      type:     One of Twig.expression.type.[type], either pre-defined or added using</span>
<span class="cm">     *                    Twig.expression.extendType</span>
<span class="cm">     *</span>
<span class="cm">     *      next:     Array of types from Twig.expression.type that can follow this token,</span>
<span class="cm">     *</span>
<span class="cm">     *      regex:    A regex or array of regex&#39;s that should match the token.</span>
<span class="cm">     *</span>
<span class="cm">     *      compile: function(token, stack, output) called when this token is being compiled.</span>
<span class="cm">     *                   Should return an object with stack and output set.</span>
<span class="cm">     *</span>
<span class="cm">     *      parse:   function(token, stack, context) called when this token is being parsed.</span>
<span class="cm">     *                   Should return an object with stack and context set.</span>
<span class="cm">     *  }</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Object} definition A token definition.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">definition</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">definition</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unable to extend logic definition. No type provided for &quot;</span> <span class="o">+</span> <span class="nx">definition</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">definition</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">definition</span><span class="p">;</span>
    <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>Extend with built-in expressions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">definitions</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">definitions</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="cm">/**</span>
<span class="cm">     * Break an expression into tokens defined in Twig.expression.definitions.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {string} expression The string to tokenize.</span>
<span class="cm">     *</span>
<span class="cm">     * @return {Array} An array of tokens.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">tokenize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">expression</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">[],</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>Keep an offset of the location in the expression for error messages.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">exp_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>The valid next tokens of the previous token</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">next</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>Match information</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">type</span><span class="p">,</span> <span class="nx">regex</span><span class="p">,</span> <span class="nx">regex_array</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>The possible next token for the match</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">token_next</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>Has a match been found from the definitions</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">match_found</span><span class="p">,</span> <span class="nx">invalid_matches</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">match_function</span><span class="p">;</span>

        <span class="nx">match_function</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span>
                <span class="nx">string</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span>
                <span class="nx">offset</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>

            <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.tokenize&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;Matched a &quot;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="s2">&quot; regular expression of &quot;</span><span class="p">,</span> <span class="nx">match</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">&amp;&amp;</span> <span class="nx">next</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">invalid_matches</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
                    <span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot; cannot follow a &quot;</span> <span class="o">+</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">type</span> <span class="o">+</span>
                           <span class="s2">&quot; at template:&quot;</span> <span class="o">+</span> <span class="nx">exp_offset</span> <span class="o">+</span> <span class="s2">&quot; near &#39;&quot;</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span>
                           <span class="s2">&quot;...&#39;&quot;</span>
                <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>Not a match, don't change the expression</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">return</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="nx">invalid_matches</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                <span class="nx">type</span><span class="o">:</span>  <span class="nx">type</span><span class="p">,</span>
                <span class="nx">value</span><span class="o">:</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="nx">match</span><span class="o">:</span> <span class="nx">match</span>
            <span class="p">});</span>

            <span class="nx">match_found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="nx">next</span> <span class="o">=</span> <span class="nx">token_next</span><span class="p">;</span>
            <span class="nx">exp_offset</span> <span class="o">+=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Twig.expression.tokenize&quot;</span><span class="p">,</span> <span class="s2">&quot;Tokenizing expression &quot;</span><span class="p">,</span> <span class="nx">expression</span><span class="p">);</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">expression</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">expression</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">type</span> <span class="k">in</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">type</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">token_next</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">next</span><span class="p">;</span>
                    <span class="nx">regex</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">regex</span><span class="p">;</span>
                    <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Checking type &quot;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="s2">&quot; on &quot;</span><span class="p">,</span> <span class="nx">expression</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">regex</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">regex_array</span> <span class="o">=</span> <span class="nx">regex</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">regex_array</span> <span class="o">=</span> <span class="p">[</span><span class="nx">regex</span><span class="p">];</span>
                    <span class="p">}</span>

                    <span class="nx">match_found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="k">while</span> <span class="p">(</span><span class="nx">regex_array</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">regex</span> <span class="o">=</span> <span class="nx">regex_array</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                        <span class="nx">expression</span> <span class="o">=</span> <span class="nx">expression</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">regex</span><span class="p">,</span> <span class="nx">match_function</span><span class="p">);</span>
                    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>An expression token has been matched. Break the for loop and start trying to
 match the next template (if expression isn't empty.)</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nx">match_found</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">match_found</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">invalid_matches</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="nx">invalid_matches</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; OR &quot;</span><span class="p">));</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unable to parse &#39;&quot;</span> <span class="o">+</span> <span class="nx">expression</span> <span class="o">+</span> <span class="s2">&quot;&#39; at template position&quot;</span> <span class="o">+</span> <span class="nx">exp_offset</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.tokenize&quot;</span><span class="p">,</span> <span class="s2">&quot;Tokenized to &quot;</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">tokens</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Compile an expression token.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Object} raw_token The uncompiled token.</span>
<span class="cm">     *</span>
<span class="cm">     * @return {Object} The compiled token.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">compile</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">raw_token</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">expression</span> <span class="o">=</span> <span class="nx">raw_token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>Tokenize expression</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">tokenize</span><span class="p">(</span><span class="nx">expression</span><span class="p">),</span>
            <span class="nx">token</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">output</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">stack</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">token_template</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Compiling &quot;</span><span class="p">,</span> <span class="nx">expression</span><span class="p">);</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Tokens tokenized to &quot;</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>Push tokens into RPN stack using the Sunting-yard algorithm
See http://en.wikipedia.org/wiki/Shunting<em>yard</em>algorithm</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">while</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
            <span class="nx">token_template</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p>Compile the template</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">token_template</span><span class="p">.</span><span class="nx">compile</span> <span class="o">&amp;&amp;</span> <span class="nx">token_template</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">while</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.compile: &quot;</span><span class="p">,</span> <span class="s2">&quot;Stack is&quot;</span><span class="p">,</span> <span class="nx">output</span><span class="p">);</span>

        <span class="nx">raw_token</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="nx">output</span><span class="p">;</span>
        <span class="k">delete</span> <span class="nx">raw_token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

        <span class="k">return</span> <span class="nx">raw_token</span><span class="p">;</span>
    <span class="p">};</span>


    <span class="cm">/**</span>
<span class="cm">     * Parse an RPN expression stack within a context.</span>
<span class="cm">     *</span>
<span class="cm">     * @param {Array} tokens An array of compiled expression tokens.</span>
<span class="cm">     * @param {Object} context The render context to parse the tokens with.</span>
<span class="cm">     *</span>
<span class="cm">     * @return {Object} The result of parsing all the tokens. The result</span>
<span class="cm">     *                  can be anything, String, Array, Object, etc... based on</span>
<span class="cm">     *                  the given expression.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tokens</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <p>If the token isn't an array, make it one.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">tokens</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="nx">tokens</span><span class="p">];</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p>The output stack</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">stack</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">token_template</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

        <span class="nx">tokens</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">token_template</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">handler</span><span class="p">[</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span>

            <span class="nx">token_template</span><span class="p">.</span><span class="nx">parse</span> <span class="o">&amp;&amp;</span> <span class="nx">token_template</span><span class="p">.</span><span class="nx">parse</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="p">[</span><span class="nx">token</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">context</span><span class="p">]);</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>Pop the final value off the stack</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">Twig</span><span class="p">;</span>

<span class="p">})(</span> <span class="nx">Twig</span> <span class="o">||</span> <span class="p">{</span> <span class="p">}</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <pre><code>Twig.js v0.3
Copyright (c) 2011 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <h2>twig.expression.operator.js</h2>

<p>This file handles operator lookups and parsing.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Twig</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Operator associativity constants.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">leftToRight</span><span class="o">:</span> <span class="s1">&#39;leftToRight&#39;</span><span class="p">,</span>
        <span class="nx">rightToLeft</span><span class="o">:</span> <span class="s1">&#39;rightToLeft&#39;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Get the precidence and associativity of an operator. These follow the order that C/C++ use.</span>
<span class="cm">     * See http://en.wikipedia.org/wiki/Operators_in_C_and_C++ for the table of values.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">lookup</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">operator</span><span class="p">,</span> <span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">operator</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;,&#39;</span><span class="o">:</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">precidence</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">leftToRight</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p>Ternary</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">case</span> <span class="s1">&#39;?&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;:&#39;</span><span class="o">:</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">precidence</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">rightToLeft</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;||&#39;</span><span class="o">:</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">precidence</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">leftToRight</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;&amp;&amp;&#39;</span><span class="o">:</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">precidence</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">leftToRight</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;==&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;!=&#39;</span><span class="o">:</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">precidence</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">leftToRight</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;&lt;&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;&lt;=&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;&gt;&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;&gt;=&#39;</span><span class="o">:</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">precidence</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">leftToRight</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>


            <span class="k">case</span> <span class="s1">&#39;~&#39;</span><span class="o">:</span> <span class="c1">// String concatination</span>
            <span class="k">case</span> <span class="s1">&#39;+&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;-&#39;</span><span class="o">:</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">precidence</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">leftToRight</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;*&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;/&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="s1">&#39;%&#39;</span><span class="o">:</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">precidence</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">leftToRight</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;!&#39;</span><span class="o">:</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">precidence</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
                <span class="nx">token</span><span class="p">.</span><span class="nx">associativity</span> <span class="o">=</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">rightToLeft</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">default</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="nx">operator</span> <span class="o">+</span> <span class="s2">&quot; is an unknown operator.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">token</span><span class="p">.</span><span class="nx">operator</span> <span class="o">=</span> <span class="nx">operator</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/**</span>
<span class="cm">     * Handle operations on the RPN stack.</span>
<span class="cm">     *</span>
<span class="cm">     * Returns the updated stack.</span>
<span class="cm">     */</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">expression</span><span class="p">.</span><span class="nx">operator</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">operator</span><span class="p">,</span> <span class="nx">stack</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">(</span><span class="s2">&quot;Twig.expression.operator.parse: &quot;</span><span class="p">,</span> <span class="s2">&quot;Handling &quot;</span><span class="p">,</span> <span class="nx">operator</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">operator</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">&#39;+&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;-&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">-</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;*&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">*</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;/&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">/</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;%&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">%</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;~&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">().</span><span class="nx">toString</span><span class="p">();</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">().</span><span class="nx">toString</span><span class="p">();</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;!&#39;</span><span class="o">:</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="o">!</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;&lt;&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;&lt;=&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">&lt;=</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;&gt;&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;&gt;=&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">&gt;=</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;==&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">==</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;!=&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">!=</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;||&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">||</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">&#39;&amp;&amp;&#39;</span><span class="o">:</span>
                <span class="nx">b</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">Twig</span><span class="p">;</span>

<span class="p">})(</span> <span class="nx">Twig</span> <span class="o">||</span> <span class="p">{</span> <span class="p">}</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <pre><code>Twig.js v0.3
Copyright (c) 2011 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <h2>twig.filters.js</h2>

<p>This file handles parsing filters.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Twig</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <p>Determine object type</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">is</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">clas</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">obj</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">clas</span> <span class="o">===</span> <span class="nx">type</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">Twig</span><span class="p">.</span><span class="nx">filters</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <p>String Filters</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">upper</span><span class="o">:</span>  <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
        <span class="p">},</span>
        <span class="nx">lower</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
        <span class="p">},</span>
        <span class="nx">capitalize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">title</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="sr">/(^|\s)([a-z])/g</span> <span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">){</span>
                <span class="k">return</span> <span class="nx">p1</span> <span class="o">+</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">},</span>
        <span class="nx">length</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">_keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <p>Array/Object Filters</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">reverse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">is</span><span class="p">(</span><span class="s2">&quot;Array&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">reverse</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">is</span><span class="p">(</span><span class="s2">&quot;String&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">||</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">reverse</span><span class="p">();</span>
                <span class="nx">value</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">sort</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">is</span><span class="p">(</span><span class="s2">&quot;Array&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Object</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <p>Sorting objects isn't obvious since the order of
returned keys isn't guaranteedin JavaScript.
Because of this we use a "hidden" key called _keys to
store the keys in the order we want to return them.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">sorted_obj</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span>
                    <span class="nx">sorted_keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">value</span><span class="p">[</span><span class="nx">a</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">value</span><span class="p">[</span><span class="nx">b</span><span class="p">];</span>
                    <span class="p">});</span>
                <span class="nx">sorted_keys</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">sorted_obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
                <span class="p">});</span>
                <span class="nx">value</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">=</span> <span class="nx">sorted_keys</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">keys</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">keyset</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">||</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">value</span><span class="p">),</span>
                <span class="nx">output</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="nx">keyset</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s2">&quot;_keys&quot;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// Ignore the _keys property</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
            <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="nx">url_encode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">join</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">join_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="nx">output</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="nx">keyset</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
                <span class="nx">join_str</span> <span class="o">=</span> <span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">output</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">keyset</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">||</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
                <span class="nx">keyset</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">===</span> <span class="s2">&quot;_keys&quot;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// Ignore the _keys property</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">output</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">join_str</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="s2">&quot;default&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">params</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">params</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;default filter expects one argument&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">json_encode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="nx">value</span><span class="p">.</span><span class="nx">_keys</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">merge</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="nx">arr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="nx">keyset</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p>Check to see if all the objects being merged are arrays</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <p>Create obj as an Object</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">params</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">param</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">obj</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">value</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">_keys</span><span class="p">)</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_keys</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">arr_index</span><span class="p">);</span>
                    <span class="nx">obj</span><span class="p">[</span><span class="nx">arr_index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
                    <span class="nx">arr_index</span><span class="o">++</span><span class="p">;</span>
                <span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">keyset</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">||</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
                <span class="nx">keyset</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
                    <span class="nx">obj</span><span class="p">.</span><span class="nx">_keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <p>Handle edge case where a number index in an object is greater than
  the array counter. In such a case, the array counter is increased
  one past the index.</p>

<p>Example {{ ["a", "b"]|merge({"4":"value"}, ["c", "d"])
Without this, d would have an index of "4" and overwrite the value
  of "value"</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="kd">var</span> <span class="nx">int_key</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">int_key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">int_key</span> <span class="o">&gt;=</span> <span class="nx">arr_index</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">arr_index</span> <span class="o">=</span> <span class="nx">int_key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <p>mixin the merge arrays</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">params</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">param</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">param</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">_keys</span><span class="p">)</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arr_index</span><span class="p">);</span>
                        <span class="nx">obj</span><span class="p">[</span><span class="nx">arr_index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
                        <span class="nx">arr_index</span><span class="o">++</span><span class="p">;</span>
                    <span class="p">});</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">keyset</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">_keys</span> <span class="o">||</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">param</span><span class="p">);</span>
                    <span class="nx">keyset</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_keys</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
                        <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">param</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>

                        <span class="kd">var</span> <span class="nx">int_key</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">int_key</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">int_key</span> <span class="o">&gt;=</span> <span class="nx">arr_index</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">arr_index</span> <span class="o">=</span> <span class="nx">int_key</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">})</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Twig</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Filter merge expects at least one parameter&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
        <span class="p">}</span>


        <span class="cm">/*convert_encoding,</span>
<span class="cm">        date,</span>
<span class="cm">        escape,</span>
<span class="cm">        format,</span>
<span class="cm">        raw,</span>
<span class="cm">        replace,</span>
<span class="cm">        striptags */</span>
    <span class="p">};</span>

    <span class="nx">Twig</span><span class="p">.</span><span class="nx">filter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">filters</span><span class="p">[</span><span class="nx">filter</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="s2">&quot;Unable to find filter &quot;</span> <span class="o">+</span> <span class="nx">filter</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">filters</span><span class="p">[</span><span class="nx">filter</span><span class="p">](</span><span class="nx">value</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">Twig</span><span class="p">.</span><span class="nx">extendFilter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">,</span> <span class="nx">definition</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">filters</span><span class="p">[</span><span class="nx">filter</span><span class="p">]</span> <span class="o">=</span> <span class="nx">definition</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">Twig</span><span class="p">;</span>
<span class="p">})(</span><span class="nx">Twig</span> <span class="o">||</span> <span class="p">{</span> <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <pre><code>Twig.js v0.3
Copyright (c) 2011 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <h2>twig.tests.js</h2>

<p>This file handles expression tests. (is empty, is not defined, etc...)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Twig</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">Twig</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
    <span class="nx">Twig</span><span class="p">.</span><span class="nx">tests</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">empty</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">value</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <p>Handle string and array</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p>Handle objects</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="nx">odd</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="nx">even</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="nx">divisibleby</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span> <span class="o">%</span> <span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="nx">defined</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="nx">none</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">value</span> <span class="o">===</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/*</span>
<span class="cm">        constant ?</span>
<span class="cm">         */</span>
    <span class="p">};</span>

    <span class="nx">Twig</span><span class="p">.</span><span class="nx">test</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Twig</span><span class="p">.</span><span class="nx">tests</span><span class="p">[</span><span class="nx">test</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="s2">&quot;Test &quot;</span> <span class="o">+</span> <span class="nx">test</span> <span class="o">+</span> <span class="s2">&quot; is not defined.&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">Twig</span><span class="p">.</span><span class="nx">tests</span><span class="p">[</span><span class="nx">test</span><span class="p">](</span><span class="nx">value</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">Twig</span><span class="p">.</span><span class="nx">extendTest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">test</span><span class="p">,</span> <span class="nx">definition</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Twig</span><span class="p">.</span><span class="nx">tests</span><span class="p">[</span><span class="nx">test</span><span class="p">]</span> <span class="o">=</span> <span class="nx">definition</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">Twig</span><span class="p">;</span>
<span class="p">})(</span> <span class="nx">Twig</span> <span class="o">||</span> <span class="p">{</span> <span class="p">}</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <pre><code>Twig.js v0.3
Copyright (c) 2011 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <h2>twig.module.js</h2>

<p>Provide a module export.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">module</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">twig</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">twig</span> <span class="o">=</span> <span class="nx">twig</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 